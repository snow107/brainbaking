<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Unit Testing Stored Procedures</title>
  
  <meta name="author" content="Wouter Groeneveld"/>
  <meta name="generator" content="Hugo 0.21" />
  <link href='https://brainbaking.com//img/favicon.ico' rel='icon' type='image/x-icon'/>

  <link rel="alternate" href="https://brainbaking.com/index.xml" type="application/rss+xml" title="Brain Baking">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://brainbaking.com//css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://brainbaking.com//css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://brainbaking.com//css/pygment_highlights.css" />
  <link rel="stylesheet" href="https://brainbaking.com/css/highlight.min.css">
  
  
  <meta property="og:title" content="Unit Testing Stored Procedures" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/post/unit-testing-stored-procedures/" />
  <meta property="og:image" content="/img/avatar-icon.png" />
  
</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://brainbaking.com/">
        <i class="fa fa-lightbulb-o" aria-hidden="true"></i>&nbsp;&nbsp;
        Brain Baking
      </a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      <li id="google-search-wrapper">
	<script>
	(function() {
	  var cx = '015035874764642922467:uhhwew4ykvm';
	  var gcse = document.createElement('script');
	  gcse.type = 'text/javascript';
	  gcse.async = true;
	  gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
	  var s = document.getElementsByTagName('script')[0];
	  s.parentNode.insertBefore(gcse, s);
	})();
	</script>

	<gcse:search></gcse:search>

	<form onsubmit="return false;">
		<label for="searchInput"><i class="fa fa-search" aria-hidden="true"></i><span class="sr-only">Search</span></label>
		<input type="text" id="searchInput" placeholder="Search">
	</form>

	<script>
	(function() {
		document.querySelector('#searchInput').addEventListener("keypress", function(event) {
			if(event.keyCode === 13) {
				event.stopPropagation();
				document.querySelector('#___gcse_0 input').value = document.querySelector('#searchInput').value;
				document.querySelector('.gsc-search-button button').click();

				var modal = document.querySelector('.gsc-modal-background-image');
				modal.attributes['class'].value = "gsc-modal-background-image gsc-modal-background-image-visible";
			}
		});
	})();
	</script>
</li>

      
        
          <li class="navlinks-container">
            <a class="navlinks-parent" href="javascript:void(0)">Menu</a>
            <div class="navlinks-children">
            
              <a href="/wiki/"><i class='fa fa-wikipedia-w'></i>&nbsp;&nbsp;Wiki</a>
            
              <a href="/tags"><i class='fa fa-tags'></i>&nbsp;&nbsp;Tags</a>
            
              <a href="/about"><i class='fa fa-address-card-o'></i>&nbsp;&nbsp;About me</a>
            
              <a href="/teaching"><i class='fa fa-graduation-cap'></i>&nbsp;&nbsp;Teaching</a>
            
              <a href="/books"><i class='fa fa-book' aria-hidden='true'></i>&nbsp;&nbsp;Books</a>
            
            </div>
          </li>
        
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
          <a title="Brain Baking" href="https://brainbaking.com/">
              <img class="avatar-img" src="https://brainbaking.com//img/avatar-icon.png" alt="Brain Baking" />
          </a>
      
	  </div>
	</div>

  </div>
</nav>

    



  
    <div id="header-big-imgs" data-num-img=1 data-img-src-1="/img/Unit%20Testing%20Stored%20Procedures.jpg"></div>
  

  <header class="header-section has-img">
  
    <div class="big-img intro-header">
        <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>Unit Testing Stored Procedures</h1>
      
        
      <h2 class="post-subheading">And a pragmatic guide on how to include them into your build system.</h2>
      
      
      
      
      <span class="post-meta">10 October 2013</span>
      
        </div>
      </div>
    </div>
  </div>
      <span class='img-desc'></span>
    </div>
  
  <div class="intro-header no-img">
      <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>Unit Testing Stored Procedures</h1>
      
        
      <h2 class="post-subheading">And a pragmatic guide on how to include them into your build system.</h2>
      
      
      
      
      <span class="post-meta">10 October 2013</span>
      
        </div>
      </div>
    </div>
  </div>
  </div>
  </header>


    <div class="container" role="main">	  
      
        <div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      
  <i class="fa fa-tags" style="float: left;" aria-hidden="true"></i>
  <ul id="tags">
  
   <li><a href="/tags/tech">tech</a> </li>
  
   <li><a href="/tags/unit-testing">unit testing</a> </li>
  
   <li><a href="/tags/sql">sql</a> </li>
  
  </ul>



      <article role="main" class="blog-post">
          

<p>This article is based on the notes I&rsquo;ve collected on <a href="http://brainbaking.com/wiki/code/db/sql">My Wiki</a>.</p>

<p>Test Driven Development (or TDD), it&rsquo;s one of those buzz words which usuallly appear in the same sentence with &ldquo;scrum&rdquo; or &ldquo;XP&rdquo;. But in practice, I&rsquo;ve seen few people actually applying it all the way through. What do I mean by that? You&rsquo;re probably very familiar with, say Java or .NET, and you know how to write unit tests in that language using your beloved IDE. That&rsquo;s a good start, right. Maybe you might even do it the test-first way: writing a failing test (letting it fail for the right reason), writing the implementation and maybe some refactoring. Red, Green, Refactor.</p>

<p>But what do you do when you need to step out of your language comfort zone to write some Javascript on the client side? Do you copypaste stuff or try to apply the same techniques as you&rsquo;re used to? You might have heard from test frameworks like <a href="http://pivotal.github.io/jasmine/">Jasmine</a> and use these. Also good for you! Client side development is very popular, but what about SQL? Do you write tests for stored procedures? I thought so. There are plenty of frameworks available to help you in doing this, for instance <a href="http://docs.oracle.com/cd/E15846_01/doc.21/e15222/unit_testing.htm">SQL Developer</a> which I used because it&rsquo;s already installed on every developer&rsquo;s PC and has a &ldquo;friendly&rdquo; interface.</p>

<p><img src="http://brainbaking.com/wiki/_media/code/db/unittest_sqldev.png" alt="sql dev unit test" /></p>

<p>Once you create a &ldquo;test repository&rdquo;, SQL Developer will create test tables to store it&rsquo;s unit test descriptions and results, prefixed by &ldquo;UT_&ldquo;. You can specify whether you&rsquo;d like to create a new scheme for it or not. When creating a new test, the tool asks you a couple of questions:</p>

<ol>
<li>What do you want to insert or execute before the test? (Setup phase)</li>
<li>What stored procedure do you want to execute? (Execute system under test phase)</li>
<li>What should the result of the procedure be, or execute a query and check it&rsquo;s results? (Verify phase)</li>
<li>What do you want to insert or execute after the test? (Teardown phase)</li>
</ol>

<p>You can reuse the parts to be executed in the different phases for another unit test, yay! This data will also be stored in the predefined tables.</p>

<h3 id="but-what-about-existing-data-when-inserting-new-stuff">But what about existing data when inserting new stuff?</h3>

<p>use this as teardown:</p>

<pre><code>ROLLBACK;
</code></pre>

<h3 id="but-how-do-you-execute-a-stored-procedure-with-in-out-ref-cursor-arguments">But how do you execute a stored procedure with IN/OUT REF CURSOR arguments?</h3>

<p>SQL Developer has some trouble executing that, indeed. In this case, we use a little trick:</p>

<ol>
<li><p>Create a dummy stored procedure:</p>

<pre><code>create or replace 
PROCEDURE UT_DUMMY AS 
BEGIN
  NULL;
END UT_DUMMY;
</code></pre></li>

<li><p>Execute the dummy procedure in the SUT phase.</p></li>

<li><p>Use the verify phase to call the actual to test procedure yourself, and do your verification stuff yourself:</p>

<pre><code>DECLARE     
  P_USERID NUMBER;     
  MY_P_CURSOR SCHEMA.PACKAGE.Cursor;     
  cursor_element MY_P_CURSOR.SCHEMA.CursorType;     
  found boolean;     
BEGIN     
  P_USERID := 11;     
  found := false;     

  PACKAGE.MYPROCEDURE(     
    P_USERID =&gt; P_USERID,     
    P_CURSOR =&gt; MY_P_CURSOR     
  );     

 WHILE TRUE LOOP     
    FETCH MY_P_CURSOR INTO cursor_element;     
    EXIT WHEN MY_P_CURSOR%NOTFOUND;     
    IF cursor_element.columntocheck = 'My value' THEN     
      found  := true;     
    END IF;     
  END LOOP;     

 IF found = false THEN     
   raise_application_error(-20000, 'Your error message in here!');     
 END IF;     

END; 
</code></pre></li>
</ol>

<h3 id="okay-but-what-about-integrating-the-exeuction-of-these-tests-in-my-build-system">Okay but what about integrating the exeuction of these tests in my build system?</h3>

<p>You can use the commandline utility provided by SQL Developer to execute a test or a suite:</p>

<pre><code>ututil -run -suite -name [name] -repo [repo] -db [db] -log 3
</code></pre>

<p>It&rsquo;s very interesting to dynamically import and export tests using &ldquo;-imp&rdquo; and &ldquo;-exp&rdquo;, and creating one suite using this PL/SQL:</p>

<pre><code>SET serveroutput ON;

delete from ut_suite_items;
delete from ut_suite;

DROP SEQUENCE ut_suite_items_seq;
CREATE SEQUENCE ut_suite_items_seq
  MINVALUE 0
  MAXVALUE 999999999999999999999999999
  START WITH 0
  INCREMENT BY 1;

DECLARE
    suiteid VARCHAR2(900) := 'ALL';
    utid VARCHAR2(900);
    cursor tableCursor is SELECT UT_ID FROM UT_TEST;
BEGIN

dbms_output.enable(10000);
DBMS_OUTPUT.PUT_LINE('Creating one test suite to rule them ALL...');

insert into ut_suite(ut_sid, coverage, name, created_on, created_by, updated_on, updated_by)
  values(suiteid, 0, suiteid, null, null, null, null);

open tableCursor;
fetch tableCursor into utid;
WHILE (tableCursor%FOUND) LOOP

  insert into ut_suite_items(ut_sid, ut_id, ut_nsid, run_start, run_tear, sequence, created_on, created_by, updated_on, updated_by)
    values (suiteid, utid, null, 'Y', 'Y', ut_suite_items_seq.nextval, null, null, null, null);

  fetch tableCursor into utid;
END LOOP;
close tableCursor;

commit;
DBMS_OUTPUT.PUT_LINE('SUCCESS - test suite created!');

END;
/
</code></pre>

<p>It creates only one suite called &lsquo;ALL&rsquo; which can then be executed. The commandline utility will output &ldquo;UT_SUCCESS&rdquo; or throw some kind of exception if one of the tests failed.</p>

<h3 id="i-still-get-errors-using-ututil-some-connectexception">I still get errors using ututil, some ConnectException?</h3>

<p>the utility cannot handle any TNS connections you&rsquo;ve entered in SQL Developer. Change these to regular connection strings and all will be well. Yes it&rsquo;s a huge disadvantage, and yes the connection settings are stored in your locally installed SQL Developer instance, which also kind of sucks. We needed to install SQL developer on the Build integration PC and configure the same connections within it.</p>

<h3 id="what-about-versioning-the-tests-are-stored-in-my-db-but-it-doesn-t-evolve-as-quickly-as-the-code-does">What about versioning? The tests are stored in my DB, but it doesn&rsquo;t evolve as quickly as the code does!</h3>

<p>Right, that&rsquo;s where the import/export thing comes in. We store the actual unit tests in XML format inside our regular source control system, next to the &ldquo;other&rdquo; unit tests (in this case in .NET). Every time someone writes a unit test using SQL developer, it extracts that test using:</p>

<pre><code>ututil -exp -test [name] -file [file] ...
</code></pre>

<p>which creates an XML file. Executing the tests happen within a wrapper .NET test class, which goes through some steps to setup the DB system correctly:</p>

<ol>
<li>Cleanup all UT_TEST* and UT_SUITE* tables which would contain the acutal tests.</li>
<li>Loop through all XML files, and impor them one by one (they get inserted into the cleaned tables)</li>
<li>Generate the &lsquo;ALL&rsquo; unit test suite - see PL/SQL above.</li>
<li>Execute the test suite using ututil and parse the results from the command line.</li>
</ol>

<p>That&rsquo;s as far as our imagination and budget goes. We have a stable system which is able to version the XML files - inserting the test data is still dependant on the actual state of the database. One could explore the dynamic creating of tables the stored procedures use, but as our codebase is legacy (read: really really old stuff), we decided not to invest too much time in that.</p>

      </article>

      <ul class="blog-pagination blog-pager">
        
        <li>
          &larr; Previous Post: <a href="https://brainbaking.com/post/vegetarians-do-not-eat-fish/" data-toggle="tooltip" data-placement="top" title="No, vegetarians do not eat fish!">No, vegetarians do not eat fish!</a>
          <span class="blog-pagination-date"> <i class="fa fa-calendar-o" aria-hidden="true"></i> 09/06/60096</span>
        </li>
        
        
        <li>
          &rarr; Next Post: <a href="https://brainbaking.com/post/learning-to-become-a-baker/" data-toggle="tooltip" data-placement="top" title="Learning to become a baker">Learning to become a baker</a>
          <span class="blog-pagination-date"> <i class="fa fa-calendar-o" aria-hidden="true"></i> 10/13/130106</span>
        </li>
        
      </ul>

      <div class="disqus-comments">

	<div id="disqus_thread"></div>
	<script type="text/javascript">
		(function() {
		      
		      
		      if (window.location.hostname == "localhost")
		                return;

		      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		      var disqus_shortname = 'brainbaking';
		      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>


    </div>
  </div>
</div>

      
    </div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="https://github.com/wgroeneveld" target="_blank" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
		      
          <li>
            <a href="mailto:wouter.groeneveld@gmail.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
	    	  
          
           
          
          
          
          
          <li>
            <a href="https://www.pinterest.com/woutergroenev" target="_blank" title="Pinterest">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-pinterest fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://www.goodreads.com/user/show/5451893-wouter" target="_blank" title="Goodreads">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-book fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          

    		  <li>
      			<a href="https://brainbaking.com/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>		

        </ul>
        <p class="credits copyright text-muted">
    	  <a href="https://brainbaking.com/about">Wouter Groeneveld</a>
    	  &nbsp;&bull;&nbsp;
    	  No copyright - <a href="https://github.com/wgroeneveld/brainbaking" target="_blank">Hack away!</a>
    		  
    	  
    	  &nbsp;&bull;&nbsp;
    	  <a href="https://brainbaking.com/">
          <i class="fa fa-lightbulb-o" aria-hidden="true"></i>&nbsp;Brain Baking
        </a>
    	  
  	    </p>
  	    
    	<p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.21</a> powered &nbsp;&bull;&nbsp; Theme by <a href="https://github.com/halogenica/beautifulhugo" target="_blank">Beautiful Hugo</a> adapted to <a href="https://github.com/wgroeneveld/beautifulbaking">Beautiful Baking</a>
          
    	</p>
      </div>
    </div>
  </div>
</footer>

<script src="https://brainbaking.com//js/jquery-1.11.2.min.js"></script>
<script src="https://brainbaking.com//js/bootstrap.min.js"></script>
<script src="https://brainbaking.com//js/main.js"></script>
<script src="https://brainbaking.com/js/highlight.min.js"></script>
<script async defer src="//assets.pinterest.com/js/pinit.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-45748221-1', 'auto');
ga('send', 'pageview');
</script>



  </body>
</html>
