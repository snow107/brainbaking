<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Integration Testing with SQLite</title>
  
  <meta name="author" content="Wouter Groeneveld"/>
  <meta name="generator" content="Hugo 0.18.1" />
  <link href='http://www.brainbaking.com//img/favicon.ico' rel='icon' type='image/x-icon'/>

  <link rel="alternate" href="http://www.brainbaking.com/index.xml" type="application/rss+xml" title="Brain Baking">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="http://www.brainbaking.com//css/bootstrap.min.css" />
  <link rel="stylesheet" href="http://www.brainbaking.com//css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="http://www.brainbaking.com//css/pygment_highlights.css" />
  <link rel="stylesheet" href="http://www.brainbaking.com/css/highlight.min.css">
  
  
  <meta property="og:title" content="Integration Testing with SQLite" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/post/integration-testing-sqlite/" />
  <meta property="og:image" content="/img/avatar-icon.png" />
  
</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://www.brainbaking.com/">
        <i class="fa fa-lightbulb-o" aria-hidden="true"></i>&nbsp;&nbsp;
        Brain Baking
      </a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      <li id="google-search-wrapper">
	<script>
	(function() {
	  var cx = '015035874764642922467:uhhwew4ykvm';
	  var gcse = document.createElement('script');
	  gcse.type = 'text/javascript';
	  gcse.async = true;
	  gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
	  var s = document.getElementsByTagName('script')[0];
	  s.parentNode.insertBefore(gcse, s);
	})();
	</script>

	<gcse:search></gcse:search>

	<form onsubmit="return false;">
		<label for="searchInput"><i class="fa fa-search" aria-hidden="true"></i><span class="sr-only">Search</span></label>
		<input type="text" id="searchInput" placeholder="Search">
	</form>

	<script>
	(function() {
		document.querySelector('#searchInput').addEventListener("keypress", function(event) {
			if(event.keyCode === 13) {
				event.stopPropagation();
				document.querySelector('#___gcse_0 input').value = document.querySelector('#searchInput').value;
				document.querySelector('.gsc-search-button input').click();

				var modal = document.querySelector('.gsc-modal-background-image');
				modal.attributes['class'].value = "gsc-modal-background-image gsc-modal-background-image-visible";
			}
		});
	})();
	</script>
</li>

      
        
          <li>
          <a title="Blog" href="/">Blog</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Wiki" href="/wiki/">Wiki</a>
  	      </li>
  	    
      
        
          <li>
          <a title="About me" href="/about">About me</a>
  	      </li>
  	    
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
          <a title="Brain Baking" href="http://www.brainbaking.com/">
              <img class="avatar-img" src="http://www.brainbaking.com//img/avatar-icon.png" alt="Brain Baking" />
          </a>
      
	  </div>
	</div>

  </div>
</nav>

    



  
    <div id="header-big-imgs" data-num-img=1 data-img-src-1="/img/Integration%20Testing%20with%20SQLite.jpg"></div>
  

  <header class="header-section has-img">
  
    <div class="big-img intro-header">
        <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>Integration Testing with SQLite</h1>
      
        
      <h2 class="post-subheading">Decoupling your integrated database environment from your development.</h2>
      
      
      
      
      <span class="post-meta">4 November 2013</span>
      
        </div>
      </div>
    </div>
  </div>
      <span class='img-desc'></span>
    </div>
  
  <div class="intro-header no-img">
      <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>Integration Testing with SQLite</h1>
      
        
      <h2 class="post-subheading">Decoupling your integrated database environment from your development.</h2>
      
      
      
      
      <span class="post-meta">4 November 2013</span>
      
        </div>
      </div>
    </div>
  </div>
  </div>
  </header>


    <div class="container" role="main">	  
      
        <div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      
  <i class="fa fa-tags" style="float: left;" aria-hidden="true"></i>
  <ul id="tags">
  
   <li><a href="/tags/unit-testing">unit testing</a> </li>
  
   <li><a href="/tags/sql">sql</a> </li>
  
   <li><a href="/tags/c">C#</a> </li>
  
   <li><a href="/tags/sqlite">sqlite</a> </li>
  
  </ul>



      <article role="main" class="blog-post">
          

<p>This article is based on the notes I&rsquo;ve collected on <a href="http://brainbaking.com/wiki/code/db/sqlite">My Wiki</a>.</p>

<p>On previous projects I&rsquo;ve worked on, development PCs came with a local version of the database scheme. Each DB change also got rolled out to those computers, which enabled us developers to fool around without breaking anything on the development (or test) environment. This is another step closer to happiness, at least for our proxy customers who didn&rsquo;t have to reinsert their test data every time we flushed something from a table. Sometimes though, there&rsquo;s some lame excuse for not having a local database installed:</p>

<ul>
<li>We have a lot of stored procedures and it&rsquo;s too hard to duplicate them locally</li>
<li>We worked like this for years, why would I want a local DB?</li>
<li>But then my data is out of sync!</li>
<li>I tried doing that but my manager says I should focus on delivering content</li>
<li>Blah blah blah</li>
</ul>

<p>Installing an Oracle XE runtime on your machine might include working around some issues which can take up some time but it&rsquo;s time well invested, compared to multiple developers connecting to one shared database. In any case, there&rsquo;s another possibility: an <strong>in-memory database</strong>, such as <a href="http://www.sqlite.org/">SQLite</a>. This does still require you to keep the upgrade scripts synced, but also enables you to get rid of a lot of annoying things like <em>foreign key constraints</em> for testing purposes.</p>

<h3 id="integrating-sqlite-with-net">Integrating SQLite with .NET</h3>

<p>Simply use <a href="http://system.data.sqlite.org/index.html/doc/trunk/www/index.wiki">System.data.SQLite</a>. For each OleDb object, there&rsquo;s an equivalent SQLite one in the correct namespace. The only problem is, some of them don&rsquo;t share an abstract object so you&rsquo;ll have to come up with an anti-corruption layer yourself. Create a connection using this connection string:</p>

<pre><code>    private SQLiteConnection SqLiteDbConnection()
    {
        return new SQLiteConnection()
            {
                ConnectionString = &quot;Data Source=:memory:;Version=3;New=True;DateTimeFormat=Ticks&quot;,
                Flags = SQLiteConnectionFlags.LogAll
            };
    }

    public void SetupDb()
    {
        using (var connection = SqLiteDbConnection())
        {
            connection.Open();
            var transaction = connection.BeginTransaction();
            var sqLiteCommand = new SQLiteCommand()
                {
                    Connection = (SQLiteConnection) connection,
                    CommandType = CommandType.Text,
                    CommandText = GetSchemaCreateSql()
                };
            sqLiteCommand.ExecuteNonQuery();
            transaction.Commit();
        }
    }
</code></pre>

<p>You need to pay attention to the <code>DateTimeFormat</code> substring in the connection string as SQLite is &ldquo;dynamically typed&rdquo;, compared to Oracle. This means it stores dates exactly the same as chars, otherwise you might encounter an error like <code>&quot;string was not recognized as a valid DateTime&quot;</code> when executing a select statement.</p>

<p><strong>Watch out with closing the DB Connection</strong> using an in-memory DB; as this completely resets everything. As soon as you open a connection, you can execute create table commands (read your stored DDL file and do it in bulk).
Your anti-corruption layer between the abstract DB Connection and SQLite/OleDB should expose a few methods. It should be able to query (with or without parameters or providing a <code>DbCommand</code>) and possibly stored procedures. This is what I&rsquo;ve come up with:</p>

<pre><code>public interface IdbConnection
{
    object QueryProcedure(string procedure, IDictionary&lt;string, object&gt; parameters, string outputParameter);

    DbParameter CreateParameter(string field, object value);

    DbCommand CreateCommand(string query);

    DataSet Query(DbCommand command);

    DataSet Query(string query);
}
</code></pre>

<p>Depending on the implementation, it&rsquo;ll return an <code>SQLiteCommand</code> or an <code>OleDbCommand</code> instance.</p>

<h3 id="creating-integration-tests-using-record-objects">Creating integration tests, using Record objects</h3>

<p>To be able to quickly insert junk in an in-memory table, I came up with a simple object-table mapping which uses reflection to scan for each property of an object, and map that property to a column in a table. Normally you would simply use your domain objects and issue a <code>save()</code> or <code>persist()</code> call using for instance <code>NHibernate</code> but we didn&rsquo;t have anything like that and this was easy to setup.</p>

<p>Create an object for each table in your unit test project, extending <code>DatabaseInsertable</code>:</p>

<pre><code>public abstract class DatabaseInsertable
{
    protected abstract string GetTable();

    public override string ToString()
    {
        var fieldDict = FieldDictionary();
        var fields = &quot;(&quot; + string.Join(&quot;,&quot;, fieldDict.Keys) + &quot;)&quot;;
        var values = &quot;(&quot; + string.Join(&quot;,&quot;, fieldDict.Values) + &quot;)&quot;;

        return &quot;insert into &quot; + GetTable() + fields + &quot; values &quot; + values;
    }

    public void Save()
    {
        DbConnection.Instance.CreateCommand(ToString()).ExecuteNonQuery();
    }

    private Dictionary&lt;string, string&gt; FieldDictionary()
    {
        var dictionary = new Dictionary&lt;string, string&gt;();

        foreach (var info in this.GetType().GetFields())
        {
            if (info.GetValue(this) != null)
            {
                dictionary.Add(info.Name, &quot;'&quot; + info.GetValue(this).ToString() + &quot;'&quot;);
            }
        }

        return dictionary;
    }
}
</code></pre>

<p>For instance:</p>

<pre><code>internal class UnitRecord : DatabaseInsertable
{
    public string creator;
    public string guid;

    protected override string GetTable()
    {
        return &quot;UNIT&quot;;
    }
}
</code></pre>

<p>Now you can simply issue <code>new UnitRecord() { creator = &quot;bla&quot;; guid = &quot;lala&quot;; }.Save();</code> and it&rsquo;s saved into the unit table, yay!</p>

      </article>

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="http://www.brainbaking.com/post/vstudio-missing-features/" data-toggle="tooltip" data-placement="top" title="Visual Studio 2012 for Eclipse users">&larr; Previous Post</a>
        </li>
        
        
        <li class="next">
          <a href="http://www.brainbaking.com/post/builders-dsl/" data-toggle="tooltip" data-placement="top" title="Enhancing the builder pattern with closures">Next Post &rarr;</a>
        </li>
        
      </ul>

      
      <div class="disqus-comments">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'brainbaking';
    var disqus_identifier = 'http:\/\/www.brainbaking.com\/post\/integration-testing-sqlite\/';
    var disqus_title = 'Integration Testing with SQLite';
    var disqus_url = 'http:\/\/www.brainbaking.com\/post\/integration-testing-sqlite\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      

    </div>
  </div>
</div>

      
    </div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="https://github.com/wgroeneveld" target="_blank" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
		      
          <li>
            <a href="mailto:wouter.groeneveld@gmail.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
	    	  
          
           
          
          
          
          
          <li>
            <a href="https://www.pinterest.com/woutergroenev" target="_blank" title="Pinterest">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-pinterest fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://www.goodreads.com/user/show/5451893-wouter" target="_blank" title="Goodreads">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-book fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          

    		  <li>
      			<a href="http://www.brainbaking.com/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>		

        </ul>
        <p class="credits copyright text-muted">
    	  Wouter Groeneveld
    	  &nbsp;&bull;&nbsp;
    	  No copyright - <a href="https://github.com/wgroeneveld/brainbaking" target="_blank">Hack away!</a>
    		  
    	  
    	  &nbsp;&bull;&nbsp;
    	  <a href="http://www.brainbaking.com/">
          <i class="fa fa-lightbulb-o" aria-hidden="true"></i>&nbsp;Brain Baking
        </a>
    	  
  	    </p>
  	    
    	<p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.18.1</a> powered &nbsp;&bull;&nbsp; Theme by <a href="https://github.com/halogenica/beautifulhugo" target="_blank">Beautiful Hugo</a> adapted to <a href="https://github.com/wgroeneveld/beautifulbaking">Beautiful Baking</a>
          
    	</p>
      </div>
    </div>
  </div>
</footer>

<script src="http://www.brainbaking.com//js/jquery-1.11.2.min.js"></script>
<script src="http://www.brainbaking.com//js/bootstrap.min.js"></script>
<script src="http://www.brainbaking.com//js/main.js"></script>
<script src="http://www.brainbaking.com/js/highlight.min.js"></script>
<script async defer src="//assets.pinterest.com/js/pinit.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-45748221-1', 'auto');
ga('send', 'pageview');
</script>



  </body>
</html>
