<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>aspectj</title>
  
  <meta name="author" content="Wouter Groeneveld"/>
  <meta name="generator" content="Hugo 0.18.1" />
  <link href='http://www.brainbaking.com//img/favicon.ico' rel='icon' type='image/x-icon'/>

  <link rel="alternate" href="http://www.brainbaking.com/index.xml" type="application/rss+xml" title="Brain Baking">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="http://www.brainbaking.com//css/bootstrap.min.css" />
  <link rel="stylesheet" href="http://www.brainbaking.com//css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="http://www.brainbaking.com//css/pygment_highlights.css" />
  <link rel="stylesheet" href="http://www.brainbaking.com/css/highlight.min.css">
  
  
  <meta property="og:title" content="aspectj" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/wiki/code/java/dynamica/aspectj/" />
  <meta property="og:image" content="/img/avatar-icon.png" />
  
</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://www.brainbaking.com/">
        <i class="fa fa-lightbulb-o" aria-hidden="true"></i>&nbsp;&nbsp;
        Brain Baking
      </a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      <li id="google-search-wrapper">
	<script>
	(function() {
	  var cx = '015035874764642922467:uhhwew4ykvm';
	  var gcse = document.createElement('script');
	  gcse.type = 'text/javascript';
	  gcse.async = true;
	  gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
	  var s = document.getElementsByTagName('script')[0];
	  s.parentNode.insertBefore(gcse, s);
	})();
	</script>

	<gcse:search></gcse:search>

	<form onsubmit="return false;">
		<label for="searchInput"><i class="fa fa-search" aria-hidden="true"></i><span class="sr-only">Search</span></label>
		<input type="text" id="searchInput" placeholder="Search">
	</form>

	<script>
	(function() {
		document.querySelector('#searchInput').addEventListener("keypress", function(event) {
			if(event.keyCode === 13) {
				event.stopPropagation();
				document.querySelector('#___gcse_0 input').value = document.querySelector('#searchInput').value;
				document.querySelector('.gsc-search-button input').click();

				var modal = document.querySelector('.gsc-modal-background-image');
				modal.attributes['class'].value = "gsc-modal-background-image gsc-modal-background-image-visible";
			}
		});
	})();
	</script>
</li>

      
        
          <li>
          <a title="Blog" href="/">Blog</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Wiki" href="/wiki/">Wiki</a>
  	      </li>
  	    
      
        
          <li>
          <a title="About me" href="/about">About me</a>
  	      </li>
  	    
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
          <a title="Brain Baking" href="http://www.brainbaking.com/">
              <img class="avatar-img" src="http://www.brainbaking.com//img/avatar-icon.png" alt="Brain Baking" />
          </a>
      
	  </div>
	</div>

  </div>
</nav>

    



  

  <header class="header-section ">
  
  <div class="intro-header no-img">
      <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="wiki-heading">
          <h1>aspectj</h1>
      
      
      
        </div>
      </div>
    </div>
  </div>
  </div>
  </header>


    <div class="container" role="main">	  
      
        
  <i class="fa fa-tags" style="float: left;" aria-hidden="true"></i>
  <ul id="tags">
  
   <li><a href="/tags/code">code</a> </li>
  
   <li><a href="/tags/java">java</a> </li>
  
   <li><a href="/tags/dynamica">dynamica</a> </li>
  
   <li><a href="/tags/aspectj">aspectj</a> </li>
  
  </ul>


        

<h1 id="loadtime-weaving-met-aspectj">Loadtime weaving met aspectJ</h1>

<h2 id="spring-weaving">Spring weaving</h2>

<p>Zie <strong>demo projectje</strong>: <img style='' src='/img//code/java/dynamica/weaving-test.zip|'></p>

<p>❗ Vanaf versie 3.0 moet <code>spring-instrument</code> in plaats van <code>spring-agent</code> gebruikt worden! (bestaat niet meer)</p>

<p>Zie <a href="http://static.springsource.org/spring/docs/3.1.0.RELEASE/reference/htmlsingle/#aop">http://static.springsource.org/spring/docs/3.1.0.RELEASE/reference/htmlsingle/#aop</a></p>

<p>Weavers:</p>

<ol>
<li><strong>aspectj jar</strong> <code>-javaagent:C:&lt;br/&gt;dvl.home&lt;br/&gt;env&lt;br/&gt;aspectj&lt;br/&gt;aspectjweaver-1.6.11.jar</code></li>
<li><strong>spring-instrument jar</strong> <code>-javaagent:C:/dvl.home/prj/comeet/tools/spring-instrument-3.1.0.RELEASE.jar</code></li>
</ol>

<h4 id="wat-heb-je-nodig-om-loadtime-weaving-te-laten-werken">Wat heb je nodig om loadtime weaving te laten werken</h4>

<h5 id="applicationcontext-xml">applicationContext.xml</h5>

<ul>
<li>met spring-configured (zelfde als <code>org.springframework.beans.factory.aspectj.AnnotationBeanConfigurerAspect</code> bean, zie <a href="http://static.springsource.org/spring/docs/3.0.0.RC2/reference/html/ch07s08.html">spring docs</a>)</li>
<li>met <code>load-time-weaver</code> op</li>
</ul>

<pre><code class="language-xml">&lt;?xml version######&quot;1.0&quot; encoding&quot;UTF-8&quot;?&gt;
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;
       xsi:schemaLocation=&quot;http:*www.springframework.org/schema/beans http:*www.springframework.org/schema/beans/spring-beans-3.0.xsd
                           http:*www.springframework.org/schema/context http:*www.springframework.org/schema/context/spring-context-3.0.xsd&quot;&gt;

    &lt;context:spring-configured/&gt;
    &lt;context:component-scan base-package=&quot;be.test&quot;/&gt;    
    &lt;context:load-time-weaver/&gt;    
&lt;/beans&gt;
</code></pre>

<h5 id="juiste-manier-van-opzetten-beans">juiste manier van opzetten beans</h5>

<p>-&gt; Een bean die <code>@Component</code> annotated is waar een andere bean die <code>@Configurable</code> ge-<code>new</code>t wordt, die via <code>@Autowired</code> injecties bevat</p>

<p>bijvroobeeld:</p>

<p>-&gt; <code>SomeBean</code></p>

<pre><code class="language-java">@Component
public class SomeBean {

    private final SomeBeanToInject someBeanToInject;

    @Autowired
    public SomeBean(SomeBeanToInject someBeanToInject) {
        System.out.println(&quot;creating some bean, got injected: &quot; + someBeanToInject);
        this.someBeanToInject = someBeanToInject;
    }

    public OtherBean createOtherBean() {
        return new OtherBean();
    }
}
</code></pre>

<p>-&gt; <code>OtherBean</code></p>

<pre><code class="language-java">@Configurable
public class OtherBean {

    private SomeBeanToDynamicallyInject someBeanToDynamicallyInject;

    @Autowired
    public void setSomeBeanToDynamicallyInject(SomeBeanToDynamicallyInject someBeanToDynamicallyInject) {
        System.out.println(&quot;Setting some dynamically injected bean! : &quot; + someBeanToDynamicallyInject);
        this.someBeanToDynamicallyInject = someBeanToDynamicallyInject;
    }
}
</code></pre>

<p>-&gt; <code>SomeBeanToDynamicallyInject</code></p>

<pre><code class="language-java">@Component
public class SomeBeanToDynamicallyInject {
    public String message = &quot;dynamically injected&quot;;
}
</code></pre>

<h4 id="aspectj-en-junit-testing">AspectJ en Junit testing</h4>

<p>De annotatie <code>@EnableLoadTimeWeaving</code> heb je <strong>NIET</strong> nodig. Het is ook niet nodig om java config klasse te verwijzen, de context xml pikt dit met component scanning op!</p>

<pre><code class="language-java">@ContextConfiguration(locations = { &quot;../../applicationContext.xml&quot; })
@RunWith(SpringJUnit4ClassRunner.class)
public class SomeBeanTest {

    @Autowired
    private SomeBean someBean;

    @Test
    public void someBeanIsDynamicallyInjected() {
        Assert.assertTrue(someBean.createOtherBean().isDynamicallyInjected());
    }
}
</code></pre>

<p>❗ <strong>Unit- en Integratietesten opsplitsen in andere source folders</strong>! Waarom?<br/><br/>
Omdat, ééns als een class file ingeladen is door de JVM, deze in het geheugen blijft zitten, en de volgende keer dat een andere test binnen dezelfde suite deze wilt gebruiken en verwacht dat die enhanched is (dus <code>@Autowired</code> geïnjecteerd), dit niet zo is, omdat een vorige gewone unit test hier een <code>new</code> van gedaan heeft en dit reeds in het geheugen steekt.</p>

<p>Is hier een oplossing voor? <code>ClassLoader</code> cache clearen op een of andere manier? Zie <a href="http://members.iinet.net.au/~macneall/Java/ClassReloading.html">http://members.iinet.net.au/~macneall/Java/ClassReloading.html</a> -</p>

<blockquote>
<p>Java classes themselves are dumped from memory when the classloader that loaded them is garbage collected. So the way to dynamically reload a class is to make sure that you control the classloader for that class. So when, all the references to instances of that class are gone, and you null the classloader itself, the runtime should collect the class itself. Then, next time an object of that class is used, it needs to be loaded again.</p>
</blockquote>

<p>Probleem doet zich voor met <code>mvn clean install</code> maar soms niet in eclipse??</p>

<h2 id="aop-xml-configuratie">aop.xml configuratie</h2>

<p>Deze wordt blijkbaar gebruikt om te bepalen wat er precies gewoven moet worden - als die er NIET is gaat hij by default alles weaven en een warning tonen in de console log:</p>

<pre><code>[AppClassLoader@17943a4] warning javax.* types are not being woven because the weaver option '-Xset:weaveJavaxPackages=true' has not been specified
</code></pre>

<p>File moet in <strong>src/main/resources/META-INF/aop.xml</strong> staan (op classpath). Content bvb:</p>

<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot;?&gt;

&lt;aspectj&gt;
    &lt;aspects&gt;
        &lt;weaver options=&quot;-Xlint:ignore -nowarn&quot;&gt;
            &lt;include within=&quot;@org.springframework.beans.factory.annotation.Configurable be.bla.blie..*&quot; /&gt;
        &lt;/weaver&gt;
    &lt;/aspects&gt;
&lt;/aspectj&gt;
</code></pre>

<h5 id="options">options</h5>

<ol>
<li><code>-Xlint:ignore -nowarn</code> negeert alle warnings dat bepaalde zaken niet gewoven kunnen worden</li>
<li><code>-verbose</code> print meer debuginfo</li>
<li><code>-showWeaveInfo</code> print wat wanneer gewoven wordt.</li>
</ol>

      
    </div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="https://github.com/wgroeneveld" target="_blank" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
		      
          <li>
            <a href="mailto:wouter.groeneveld@gmail.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
	    	  
          
           
          
          
          
          
          <li>
            <a href="https://www.pinterest.com/woutergroenev" target="_blank" title="Pinterest">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-pinterest fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://www.goodreads.com/user/show/5451893-wouter" target="_blank" title="Goodreads">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-book fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          

    		  <li>
      			<a href="http://www.brainbaking.com/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>		

        </ul>
        <p class="credits copyright text-muted">
    	  Wouter Groeneveld
    	  &nbsp;&bull;&nbsp;
    	  No copyright - <a href="https://github.com/wgroeneveld/brainbaking" target="_blank">Hack away!</a>
    		  
    	  
    	  &nbsp;&bull;&nbsp;
    	  <a href="http://www.brainbaking.com/">
          <i class="fa fa-lightbulb-o" aria-hidden="true"></i>&nbsp;Brain Baking
        </a>
    	  
  	    </p>
  	    
    	<p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.18.1</a> powered &nbsp;&bull;&nbsp; Theme by <a href="https://github.com/halogenica/beautifulhugo" target="_blank">Beautiful Hugo</a> adapted to <a href="https://github.com/wgroeneveld/beautifulbaking">Beautiful Baking</a>
          
    	</p>
      </div>
    </div>
  </div>
</footer>

<script src="http://www.brainbaking.com//js/jquery-1.11.2.min.js"></script>
<script src="http://www.brainbaking.com//js/bootstrap.min.js"></script>
<script src="http://www.brainbaking.com//js/main.js"></script>
<script src="http://www.brainbaking.com/js/highlight.min.js"></script>
<script async defer src="//assets.pinterest.com/js/pinit.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-45748221-1', 'auto');
ga('send', 'pageview');
</script>



  </body>
</html>
