<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>reflectie</title>
  
  <meta name="author" content="Wouter Groeneveld"/>
  <meta name="generator" content="Hugo 0.21" />
  <link href='http://www.brainbaking.com//img/favicon.ico' rel='icon' type='image/x-icon'/>

  <link rel="alternate" href="http://www.brainbaking.com/index.xml" type="application/rss+xml" title="Brain Baking">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="http://www.brainbaking.com//css/bootstrap.min.css" />
  <link rel="stylesheet" href="http://www.brainbaking.com//css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="http://www.brainbaking.com//css/pygment_highlights.css" />
  <link rel="stylesheet" href="http://www.brainbaking.com/css/highlight.min.css">
  
  
  <meta property="og:title" content="reflectie" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/wiki/code/csharp/reflectie/" />
  <meta property="og:image" content="/img/avatar-icon.png" />
  
</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://www.brainbaking.com/">
        <i class="fa fa-lightbulb-o" aria-hidden="true"></i>&nbsp;&nbsp;
        Brain Baking
      </a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      <li id="google-search-wrapper">
	<script>
	(function() {
	  var cx = '015035874764642922467:uhhwew4ykvm';
	  var gcse = document.createElement('script');
	  gcse.type = 'text/javascript';
	  gcse.async = true;
	  gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
	  var s = document.getElementsByTagName('script')[0];
	  s.parentNode.insertBefore(gcse, s);
	})();
	</script>

	<gcse:search></gcse:search>

	<form onsubmit="return false;">
		<label for="searchInput"><i class="fa fa-search" aria-hidden="true"></i><span class="sr-only">Search</span></label>
		<input type="text" id="searchInput" placeholder="Search">
	</form>

	<script>
	(function() {
		document.querySelector('#searchInput').addEventListener("keypress", function(event) {
			if(event.keyCode === 13) {
				event.stopPropagation();
				document.querySelector('#___gcse_0 input').value = document.querySelector('#searchInput').value;
				document.querySelector('.gsc-search-button input').click();

				var modal = document.querySelector('.gsc-modal-background-image');
				modal.attributes['class'].value = "gsc-modal-background-image gsc-modal-background-image-visible";
			}
		});
	})();
	</script>
</li>

      
        
          <li class="navlinks-container">
            <a class="navlinks-parent" href="javascript:void(0)">Menu</a>
            <div class="navlinks-children">
            
              <a href="/wiki/"><i class='fa fa-wikipedia-w'></i>&nbsp;&nbsp;Wiki</a>
            
              <a href="/tags"><i class='fa fa-tags'></i>&nbsp;&nbsp;Tags</a>
            
              <a href="/about"><i class='fa fa-address-card-o'></i>&nbsp;&nbsp;About me</a>
            
              <a href="/teaching"><i class='fa fa-graduation-cap'></i>&nbsp;&nbsp;Teaching</a>
            
              <a href="/books"><i class='fa fa-book' aria-hidden='true'></i>&nbsp;&nbsp;Books</a>
            
            </div>
          </li>
        
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
          <a title="Brain Baking" href="http://www.brainbaking.com/">
              <img class="avatar-img" src="http://www.brainbaking.com//img/avatar-icon.png" alt="Brain Baking" />
          </a>
      
	  </div>
	</div>

  </div>
</nav>

    



  

  <header class="header-section ">
  
  <div class="intro-header no-img">
      <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="wiki-heading">
          <h1>reflectie</h1>
      
      
      
        </div>
      </div>
    </div>
  </div>
  </div>
  </header>


    <div class="container" role="main">	  
      
        
  <i class="fa fa-tags" style="float: left;" aria-hidden="true"></i>
  <ul id="tags">
  
   <li><a href="/tags/code">code</a> </li>
  
   <li><a href="/tags/csharp">csharp</a> </li>
  
   <li><a href="/tags/reflectie">reflectie</a> </li>
  
  </ul>


        

<h1 id="reflectie">Reflectie</h1>

<h2 id="get-type-based-on-string">Get Type based on string</h2>

<p>Probleem: een fully qualified classname in string vorm is geen <code>Type</code> en <code>Type.GetType()</code> gaat standaard in de huidige assembly kijken of die klasse daar in steekt. Hoe haal ik dit type op als ik niet vanbuiten weet in welke assembly ik moet gaan kijken? Via uw <code>AppDomain</code>:</p>

<pre><code class="language-csharp">                    return AppDomain.CurrentDomain.GetAssemblies()
                        .Single(app ######&gt; app.GetType(fullClassName) ! null)
                        .GetType(fullClassName);
</code></pre>

<h2 id="get-subclasses-interfaces-of-class">Get Subclasses/interfaces of class</h2>

<p>Gebruik <code>type.Assembly.GetTypes()</code> en filter verder.</p>

<ol>
<li>Als je een <strong>interface</strong> wil hebben, moet je <code>IsAssignableFrom()</code> gebruiken (in de omgekeerde richting).</li>
<li>Als je een <strong>subklasse</strong> wil hebben, moet je ofwel de <code>.BaseType</code> property gebruiken als direct kind, ofwel de <code>IsSubclassOf()</code> method.</li>
</ol>

<pre><code class="language-csharp">        public string HandleMessage(IHostService hostService)
        {
            var requestType = typeof (IHostServiceNativeRequest);
            var handlerType = requestType.Assembly.GetTypes()
                                         .Where(requestType.IsAssignableFrom)
                                         .Single(t ######&gt; (NativeRequestInstance(t)).Key  Key);

            return NativeRequestInstance(handlerType).ParseRequest(hostService);
        }

        private IHostServiceNativeRequest NativeRequestInstance(Type t)
        {
            return (IHostServiceNativeRequest) Activator.CreateInstance(t);
        }
</code></pre>

<h2 id="reflective-instantiation">Reflective instantiation</h2>

<p>Zie vorig voorbeeld; een nieuwe instantie van een <code>Type</code> maken kan via <code>Activator.CreateInstance()</code>.</p>

<h5 id="protected-constructor-with-arguments">Protected constructor with arguments</h5>

<pre><code class="language-csharp">            return (T)Activator.CreateInstance(typeof(T),
                BindingFlags.NonPublic | BindingFlags.CreateInstance | BindingFlags.Instance,
                null, new object[] { arg1 }, CultureInfo.CurrentCulture);
</code></pre>

<h2 id="appdomains">AppDomains</h2>

<h5 id="q-ik-wil-een-dll-dynamisch-laden">Q: Ik wil een DLL dynamisch laden</h5>

<p>Gebruik <code>Assembly.LoadFrom(string)</code>.</p>

<h5 id="q-ik-wil-loopen-over-alle-appdomains">Q: Ik wil loopen over alle AppDomains</h5>

<p>Niet zo simpel te realiseren: (zie <a href="http:*stackoverflow.com/questions/14758915/get-all-processes-with-their-corresponding-app-domains">http:*stackoverflow.com/questions/14758915/get-all-processes-with-their-corresponding-app-domains</a>)</p>

<pre><code class="language-csharp">private static List&lt;AppDomainInf&gt; GetAppDomains()
    {
        IList&lt;AppDomain&gt; mAppDomainsList = new List&lt;AppDomain&gt;();
        List&lt;AppDomainInf&gt; mAppDomainInfos = new List&lt;AppDomainInf&gt;();

        IntPtr menumHandle = IntPtr.Zero;
        ICorRuntimeHost host = new CorRuntimeHost();

        try
        {
            host.EnumDomains(out menumHandle);
            object mTempDomain = null;

            //add all the current app domains running
            while (true)
            {
                host.NextDomain(menumHandle, out mTempDomain);
                if (mTempDomain ###### null) break;
                AppDomain tempDomain = mTempDomain as AppDomain;
                mAppDomainsList.Add((tempDomain));
            }

            //retrieve every app domains detailed information
            foreach (var appDomain in mAppDomainsList)
            {
                AppDomainInf domainInf = new AppDomainInf();

                domainInf.Assemblies = GetAppDomainAssemblies(appDomain);
                domainInf.AppDomainName = appDomain.FriendlyName;

                mAppDomainInfos.Add(domainInf);
            }

            return mAppDomainInfos;
        }
        catch (Exception)
        {
            throw; //rethrow
        }
        finally
        {
            host.CloseEnum(menumHandle);
            Marshal.ReleaseComObject(host);
        }
    }
</code></pre>

<p>Ref toevoegen, mscoree.tld in .NET root folder.</p>

<p>############= Generic Type arguments &amp; reflectie ############=</p>

<h6 id="q-ik-wil-een-type-meegeven-dat-moet-extenden-van-een-basisklasse-waarna-ik-dat-type-wil-instantiëren">Q: Ik wil een Type meegeven dat moet extenden van een basisklasse, waarna ik dat type wil instantiëren.</h6>

<pre><code class="language-csharp">protected IList&lt;TInsertable&gt; Load&lt;TInsertable&gt;() where TInsertable : DatabaseInsertable
{
    var myInstance = Activator.CreateInstance(typeof(TInsertable));
}
</code></pre>

<p>❗️ <code>Type</code> zelf is niet generic omdat dit at-runtime gebruikt wordt voor typeinformatie en de andere dingen at-compiletime. Je kan dus geen <code>Type&lt;T&gt; where T : MyClass</code> gebruiken, zoals in Java bijvoorbeeld <code>Class&lt;? extends MyClass&gt;</code> gebruikt wordt. Merk op dat in Java er met het generic type argument geen klasse aangemaakt kan worden, zie <a href="/wiki/code/java/reflectie/">code/java/reflectie</a> voor java.</p>

<h6 id="q-ik-wil-een-variabel-aantal-generic-type-argumenten-definiëren">Q: Ik wil een variabel aantal generic type argumenten definiëren</h6>

<p>Genaaid, dit gaat niet. Kijk maar naar bijvoorbeeld <code>Func&lt;&gt;</code>:</p>

<ol>
<li><code>Func&lt;in T1, in T2, out Result&gt;</code></li>
<li><code>Func&lt;in T1, in T2, in T3, out Result&gt;</code></li>
<li><code>Func&lt;in T1, in T2, in T3, in T4, out Result&gt;</code></li>
<li>&hellip;</li>
</ol>

<p>Je kan die wel allemaal laten refereren naar één (private) methode die <code>params[]</code> gebruikt, bijvoorbeeld onderstaande count:</p>

<pre><code class="language-csharp">        protected int Count&lt;TInsertable&gt;()
            where TInsertable : DatabaseInsertable
        {
            return Count(typeof (TInsertable));
        }

        protected int Count&lt;TInsertable1, TInsertable2&gt;()
            where TInsertable1 : DatabaseInsertable
            where TInsertable2 : DatabaseInsertable
        {
            return Count(typeof (TInsertable1), typeof (TInsertable2));
        }

        protected int Count&lt;TInsertable1, TInsertable2, TInsertable3&gt;() 
            where TInsertable1 : DatabaseInsertable
            where TInsertable2 : DatabaseInsertable
            where TInsertable3 : DatabaseInsertable
        {
            return Count(typeof (TInsertable1), typeof (TInsertable2), typeof (TInsertable3));
        }

        private int Count(params Type[] insertableTypes)
        {
            var count = 0;
            foreach (var type in insertableTypes)
            {
                var select = &quot;select count(*) from &quot; + GetTableOfType(type);
                count += Int32.Parse(factory.CreateCommand(this.connection, select).ExecuteScalar().ToString());
            }
            return count;
        }
</code></pre>

<p>############= Reflectie en dynamisch code genereren ############=</p>

<p>Mogelijk met <strong>Reflection EMIT</strong>, om dynamisch IL code te genereren. IL is de bytecode tussenlaag in .NET, die je ook in C# kan schrijven.</p>

<p>Compleet voorbeeld: <a href="http://www.codeproject.com/Articles/121568/Dynamic-Type-Using-Reflection-Emit">http://www.codeproject.com/Articles/121568/Dynamic-Type-Using-Reflection-Emit</a></p>

<p>Bijvoorbeeld, om een getal te delen door een ander met <code>getal / other</code>, genereert de volgende code dit in IL:</p>

<pre><code class="language-csharp">MethodBuilder mDivide = tbuilder.DefineMethod(&quot;Divide&quot;, MethodAttributes.Public |
    MethodAttributes.HideBySig |
    MethodAttributes.NewSlot |
    MethodAttributes.Virtual |
    MethodAttributes.Final,
    CallingConventions.Standard,
    typeof(System.Single),
    new Type[] { typeof(System.Int32), typeof(System.Int32) });
mDivide.SetImplementationFlags(MethodImplAttributes.Managed);
ILGenerator dil = mDivide.GetILGenerator();

dil.Emit(OpCodes.Nop);
Label lblTry = dil.BeginExceptionBlock();

dil.Emit(OpCodes.Nop);
dil.Emit(OpCodes.Ldarg_1);
dil.Emit(OpCodes.Ldarg_2);
dil.Emit(OpCodes.Div);
dil.Emit(OpCodes.Conv_R4); // Converts to Float32
dil.Emit(OpCodes.Stloc_1);
dil.Emit(OpCodes.Leave, lblTry);

dil.BeginCatchBlock(typeof(DivideByZeroException));
dil.Emit(OpCodes.Stloc_0);
dil.Emit(OpCodes.Nop);
dil.Emit(OpCodes.Ldstr, &quot;ZeroDivide exception : {0}&quot;);
dil.Emit(OpCodes.Ldloc_0);
MethodInfo minfo = typeof(DivideByZeroException).GetMethod(&quot;get_Message&quot;);
dil.Emit(OpCodes.Callvirt, minfo);
MethodInfo wl = typeof(System.Console).GetMethod(&quot;WriteLine&quot;, new Type[] 
                                      { typeof(string), typeof(object) });
dil.Emit(OpCodes.Call, wl);
dil.Emit(OpCodes.Nop);
dil.Emit(OpCodes.Ldc_R4, 0.0);
dil.Emit(OpCodes.Stloc_1);
dil.Emit(OpCodes.Leave_S, lblTry);

dil.EndExceptionBlock();
dil.Emit(OpCodes.Nop);
dil.Emit(OpCodes.Ldloc_1);
dil.Emit(OpCodes.Ret);
</code></pre>

<p>Genereert dit in IL:</p>

<pre><code>.method public hidebysig newslot virtual final 
            instance float32  Divide(int32 firstnum,
                        int32 secondnum) cil managed
    {
        // Code size       39 (0x27)
        .maxstack  2
        .locals init (class [mscorlib]System.DivideByZeroException V_0,
                float32 V_1)
        IL_0000:  nop
        .try
        {
        IL_0001:  nop
        IL_0002:  ldarg.1
        IL_0003:  ldarg.2
        IL_0004:  div
        IL_0005:  conv.r4
        IL_0006:  stloc.1
        IL_0007:  leave.s    IL_0024
        }  // end .try
        catch [mscorlib]System.DivideByZeroException 
        {
        IL_0009:  stloc.0
        IL_000a:  nop
        IL_000b:  ldstr      &quot;ZeroDivide exception : {0}&quot;
        IL_0010:  ldloc.0
        IL_0011:  callvirt   instance string [mscorlib]System.Exception::get_Message()
        IL_0016:  call       void [mscorlib]System.Console::WriteLine(string,
                                                                        object)
        IL_001b:  nop
        IL_001c:  ldc.r4     0.0
        IL_0021:  stloc.1
        IL_0022:  leave.s    IL_0024
        }  // end handler
        IL_0024:  nop
        IL_0025:  ldloc.1
        IL_0026:  ret
    }
</code></pre>

      
    </div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="https://github.com/wgroeneveld" target="_blank" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
		      
          <li>
            <a href="mailto:wouter.groeneveld@gmail.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
	    	  
          
           
          
          
          
          
          <li>
            <a href="https://www.pinterest.com/woutergroenev" target="_blank" title="Pinterest">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-pinterest fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://www.goodreads.com/user/show/5451893-wouter" target="_blank" title="Goodreads">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-book fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          

    		  <li>
      			<a href="http://www.brainbaking.com/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>		

        </ul>
        <p class="credits copyright text-muted">
    	  <a href="http://www.brainbaking.com/about">Wouter Groeneveld</a>
    	  &nbsp;&bull;&nbsp;
    	  No copyright - <a href="https://github.com/wgroeneveld/brainbaking" target="_blank">Hack away!</a>
    		  
    	  
    	  &nbsp;&bull;&nbsp;
    	  <a href="http://www.brainbaking.com/">
          <i class="fa fa-lightbulb-o" aria-hidden="true"></i>&nbsp;Brain Baking
        </a>
    	  
  	    </p>
  	    
    	<p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.21</a> powered &nbsp;&bull;&nbsp; Theme by <a href="https://github.com/halogenica/beautifulhugo" target="_blank">Beautiful Hugo</a> adapted to <a href="https://github.com/wgroeneveld/beautifulbaking">Beautiful Baking</a>
          
    	</p>
      </div>
    </div>
  </div>
</footer>

<script src="http://www.brainbaking.com//js/jquery-1.11.2.min.js"></script>
<script src="http://www.brainbaking.com//js/bootstrap.min.js"></script>
<script src="http://www.brainbaking.com//js/main.js"></script>
<script src="http://www.brainbaking.com/js/highlight.min.js"></script>
<script async defer src="//assets.pinterest.com/js/pinit.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-45748221-1', 'auto');
ga('send', 'pageview');
</script>



  </body>
</html>
